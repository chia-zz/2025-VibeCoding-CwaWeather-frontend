<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ä¾†é»å¤©æ°£å§</title>
    <link rel="icon" type="image/png" href="02.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      // è¨­å®š Tailwind çš„æ“´å……è¨­å®šï¼Œæ–¹ä¾¿ç®¡ç†é¡è‰²
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              glass: {
                dark: "rgba(30, 30, 30, 0.4)",
                light: "rgba(255, 255, 255, 0.5)",
              },
            },
          },
        },
      };
    </script>

    <style>
      /* --- å…¨å±€è¨­å®š --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: "Kiwi Maru", serif;
        min-height: 100vh;
        overflow-x: hidden;
        transition: background 1.5s ease, color 0.5s ease;
        position: relative;
        color: #ffffff;
      }

      body.light-mode {
        color: #1f2937;
      }
      body.dark-mode {
        color: #ffffff;
      }

      /* --- èƒŒæ™¯æ¼¸å±¤ (æ™‚é–“æ§åˆ¶) --- */
      .bg-dawn {
        background: linear-gradient(
          to bottom,
          #5d6d9c 0%,
          #8baecf 50%,
          #e0d2a8 100%
        );
      }
      .bg-morning {
        background: linear-gradient(
          to bottom,
          #5c9ac7 0%,
          #7db0d8 50%,
          #c1dcf5 100%
        );
      }
      .bg-noon {
        background: linear-gradient(
          to bottom,
          #0d7cb8 0%,
          #3a9ccf 50%,
          #9bc4e0 100%
        );
      }
      .bg-afternoon {
        background: linear-gradient(
          to bottom,
          #1a4d7a 0%,
          #4a9ccc 50%,
          #b8d4eb 100%
        );
      }
      .bg-sunset {
        background: linear-gradient(
          to bottom,
          #8a9ab8 0%,
          #baadc5 50%,
          #f0d5c4 100%
        );
      }
      .bg-evening {
        background: linear-gradient(
          to bottom,
          #4a4874 0%,
          #8c6a9d 50%,
          #ccaba0 100%
        );
      }
      .bg-night {
        background: linear-gradient(
          to bottom,
          #0f1219 0%,
          #0a1935 50%,
          #152a4a 100%
        );
      }
      .bg-rainy {
        background: linear-gradient(
          to bottom,
          #3b4761 0%,
          #636c82 50%,
          #8a91a3 100%
        );
      }

      /* èƒŒæ™¯å±¤ (å›ºå®šä½ç½®ï¼Œåªåšå‹•ç•«/è£é£¾) */
      #decorations {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: -1;
      }
      .cloud-shape {
        position: absolute;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        filter: blur(30px);
        animation: drift linear infinite;
      }
      @keyframes drift {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(100vw);
        }
      }
      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle ease-in-out infinite;
      }
      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        50% {
          opacity: 1;
          transform: scale(1.2);
        }
      }
      .rain-drop {
        position: absolute;
        background: rgba(255, 255, 255, 0.5);
        width: 1px;
        animation: rainfall linear infinite;
      }
      @keyframes rainfall {
        to {
          transform: translateY(100vh);
        }
      }

      /* --- ç»ç’ƒè³ªæ„Ÿå¡ç‰‡ (å— light/dark æ¨¡å¼æ§åˆ¶) --- */
      .glass-card {
        transition: all 0.3s ease;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
      }

      body.dark-mode .glass-card {
        background: rgba(30, 30, 30, 0.4);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      body.light-mode .glass-card {
        background: rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px rgba(100, 100, 200, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.8);
      }

      /* --- ä¸‹æ‹‰é¸å–®/åˆ‡æ›é–‹é—œ (æ¨£å¼ç¢¼çœç•¥ï¼Œå› ç‚ºä¿æŒä¸è®Šï¼Œä½†è¨˜å¾—è¦åœ¨ final HTML è£¡) --- */

      /* é€™è£¡çœç•¥äº† dropdown å’Œ theme-switch çš„é•·ç¯‡ CSSï¼Œä¿æŒå…¶åŠŸèƒ½å’Œå¤–è§€ä¸è®Š */
      .city-dropdown {
        position: relative;
        width: 100%;
        max-width: 180px;
        z-index: 50;
      }
      .dropdown-btn {
        width: 100%;
        padding: 8px 16px;
        border-radius: 99px;
        font-size: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      body.dark-mode .dropdown-btn {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      body.light-mode .dropdown-btn {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid white;
      }
      .dropdown-content {
        display: none;
        position: absolute;
        top: 115%;
        left: 0;
        width: 100%;
        border-radius: 16px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        z-index: 100;
      }
      body.dark-mode .dropdown-content {
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      body.light-mode .dropdown-content {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid white;
      }
      .dropdown-content.show {
        display: block;
      }
      .dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
      }
      body.dark-mode .dropdown-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      body.light-mode .dropdown-item {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }
      .dropdown-item:hover {
        opacity: 0.8;
      }
      body.dark-mode .dropdown-item.selected {
        background: rgba(255, 255, 255, 0.15);
        font-weight: bold;
      }
      body.light-mode .dropdown-item.selected {
        background: rgba(0, 0, 0, 0.05);
        font-weight: bold;
      }

      .theme-switch {
        position: relative;
        width: 60px;
        height: 30px;
        border-radius: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 4px;
        transition: all 0.5s ease;
        overflow: hidden;
      }
      body.dark-mode .theme-switch {
        background: #1a1c29;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      body.light-mode .theme-switch {
        background: #89cff0;
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .theme-handle {
        position: absolute;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        left: 4px;
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55),
          background 0.3s;
        box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);
      }
      .theme-handle::before,
      .theme-handle::after {
        content: "";
        position: absolute;
        border-radius: 50%;
        transition: opacity 0.3s;
      }
      body.dark-mode .theme-handle {
        background: #d1d5db;
      }
      body.dark-mode .theme-handle::before {
        top: 4px;
        left: 4px;
        width: 5px;
        height: 5px;
        background: #9ca3af;
        opacity: 1;
      }
      body.dark-mode .theme-handle::after {
        top: 10px;
        left: 10px;
        width: 3px;
        height: 3px;
        background: #9ca3af;
        opacity: 1;
      }
      body.light-mode .theme-handle {
        transform: translateX(30px);
        background: #fcd34d;
      }
      body.light-mode .theme-handle::before,
      body.light-mode .theme-handle::after {
        opacity: 0;
      }
      .switch-decor {
        position: absolute;
        font-size: 10px;
        transition: opacity 0.3s, transform 0.5s;
      }
      .stars {
        right: 8px;
        color: white;
      }
      .clouds {
        left: 8px;
        color: white;
      }
      body.dark-mode .stars {
        opacity: 1;
        transform: translateY(0);
      }
      body.dark-mode .clouds {
        opacity: 0;
        transform: translateY(10px);
      }
      body.light-mode .stars {
        opacity: 0;
        transform: translateY(-10px);
      }
      body.light-mode .clouds {
        opacity: 1;
        transform: translateY(0);
      }

      /* --- å…¶ä»–æ¨£å¼ç¶­æŒä¸è®Š --- */
      .temp-display {
        font-size: 5.5rem;
        font-weight: 300;
        line-height: 1;
        letter-spacing: -2px;
      }
      .loading-screen {
        position: fixed;
        inset: 0;
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        transition: opacity 0.5s;
      }
      body.dark-mode .loading-screen {
        background: #1a1c29;
        color: white;
      }
      body.light-mode .loading-screen {
        background: #e0f2fe;
        color: #0284c7;
      }
      .fade-in {
        animation: fadeIn 0.8s ease-out forwards;
        opacity: 0;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      .fallback-emoji {
        font-size: 4rem;
        display: none;
      }
      img.error + .fallback-emoji {
        display: block;
      }
      img.error {
        display: none;
      }
    </style>
  </head>

  <body id="mainBody" class="dark-mode bg-morning">
    <div id="decorations"></div>

    <div id="loading" class="loading-screen">
      <div class="text-6xl animate-bounce">â˜ï¸</div>
      <p class="text-lg mt-4 font-medium tracking-wider" id="loadingText">
        æ­£åœ¨å˜—è©¦å®šä½...
      </p>
    </div>

    <div class="relative z-0 min-h-screen flex flex-col p-6 max-w-md mx-auto">
      <div
        class="flex justify-between items-center mb-6 fade-in relative z-50"
        style="animation-delay: 0.1s"
      >
        <div class="city-dropdown">
          <div class="dropdown-btn glass-card" id="dropdownBtn">
            <span>ğŸ“</span>
            <span id="selectedCity" class="font-medium tracking-wide"
              >è‡ºåŒ—å¸‚</span
            >
            <span class="text-xs opacity-70">â–¼</span>
          </div>
          <div class="dropdown-content" id="dropdownContent"></div>
        </div>

        <div class="theme-switch" id="themeToggle">
          <div class="switch-decor stars">âœ¨</div>
          <div class="switch-decor clouds">â˜ï¸</div>
          <div class="theme-handle"></div>
        </div>
      </div>

      <div
        id="mainContent"
        class="flex-1 flex flex-col hidden fade-in relative z-0"
        style="animation-delay: 0.3s"
      >
        <div class="text-center mb-8 relative z-0">
          <h1
            id="clockTime"
            class="text-6xl font-light tracking-wider drop-shadow-sm"
          >
            --:--
          </h1>
          <p id="clockDate" class="text-lg opacity-80 mt-1">--æœˆ--æ—¥</p>
        </div>

        <div id="heroCard" class="mb-6"></div>

        <div id="adviceCard" class="glass-card p-4 mb-8"></div>

        <div>
          <h3
            class="opacity-80 text-sm font-bold mb-3 px-1 flex items-center gap-2"
          >
            <span>ğŸ•’</span> ç¨å¾Œé å ±
          </h3>
          <div class="grid grid-cols-2 gap-4" id="futureForecasts"></div>
        </div>

        <div class="mt-auto pt-6 text-center opacity-40 text-xs">
          Weather Data provided by CWA
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "https://2025vc-weather.zeabur.app/api/weather";
      // IP å®šä½ API
      const GEOIP_API_URL = "https://ip-api.com/json?lang=zh-TW";
      let currentCity = "è‡ºåŒ—å¸‚"; // é è¨­åŸå¸‚

      // 3D Icon è¨­å®š (ä¸è®Š)
      const BASE_ICON_URL =
        "https://cdn.jsdelivr.net/gh/microsoft/fluentui-system-icons@master/assets/Weather";
      const ICON_MAP = {
        sunny: `${BASE_ICON_URL}/Sunny/3d/sunny_3d.png`,
        cloudy: `${BASE_ICON_URL}/Cloudy/3d/cloudy_3d.png`,
        partlyCloudyDay: `${BASE_ICON_URL}/Partly%20Cloudy%20Day/3d/partly_cloudy_day_3d.png`,
        partlyCloudyNight: `${BASE_ICON_URL}/Partly%20Cloudy%20Night/3d/partly_cloudy_night_3d.png`,
        rain: `${BASE_ICON_URL}/Rain/3d/rain_3d.png`,
        thunder: `${BASE_ICON_URL}/Thunderstorm/3d/thunderstorm_3d.png`,
        snow: `${BASE_ICON_URL}/Snow/3d/snow_3d.png`,
        clearNight: `${BASE_ICON_URL}/Clear%20Night/3d/clear_night_3d.png`,
      };

      // --- æ ¸å¿ƒé‚è¼¯ ---

      function getWeatherAssets(weatherText, startTime) {
        const hour = new Date(startTime).getHours();
        const isNight = hour >= 18 || hour < 6;

        let url = ICON_MAP.partlyCloudyDay;
        let emoji = "â›…";

        if (weatherText.includes("é›·")) {
          url = ICON_MAP.thunder;
          emoji = "â›ˆï¸";
        } else if (weatherText.includes("é›ª")) {
          url = ICON_MAP.snow;
          emoji = "â„ï¸";
        } else if (weatherText.includes("é›¨")) {
          url = ICON_MAP.rain;
          emoji = "ğŸŒ§ï¸";
        } else if (weatherText.includes("å¤šé›²") || weatherText.includes("é™°")) {
          url = isNight ? ICON_MAP.partlyCloudyNight : ICON_MAP.cloudy;
          emoji = isNight ? "â˜ï¸" : "â˜ï¸";
        } else if (weatherText.includes("æ™´")) {
          url = isNight ? ICON_MAP.clearNight : ICON_MAP.sunny;
          emoji = isNight ? "ğŸŒ™" : "â˜€ï¸";
        } else {
          url = isNight ? ICON_MAP.partlyCloudyNight : ICON_MAP.partlyCloudyDay;
          emoji = isNight ? "ğŸŒ™" : "â›…";
        }
        return { url, emoji };
      }

      function getRelativeTimeLabel(startTime) {
        const now = new Date();
        const forecastDate = new Date(startTime);
        const hour = forecastDate.getHours();

        const diffDays = forecastDate.getDate() - now.getDate();

        let period = "";
        if (hour >= 5 && hour < 11) period = "æ—©ä¸Š";
        else if (hour >= 11 && hour < 13) period = "ä¸­åˆ";
        else if (hour >= 13 && hour < 18) period = "ä¸‹åˆ";
        else if (hour >= 18 && hour < 23) period = "æ™šä¸Š";
        else period = "æ·±å¤œ";

        if (diffDays === 0) {
          const currentHour = now.getHours();
          if (
            (hour >= 6 && hour < 18 && currentHour < 18) ||
            hour >= 18 ||
            (hour < 6 && currentHour >= 18) ||
            currentHour < 6
          ) {
            return period;
          }
          return `ä»Šå¤©${period}`;
        } else if (diffDays === 1) {
          return `æ˜å¤©${period}`;
        } else {
          return `å¾Œå¤©${period}`;
        }
      }

      // --- æœè£å»ºè­°å‡½å¼ (å„ªåŒ–ç‰ˆï¼Œè§£æ±ºå•é¡Œ 2) ---
      function getAdvice(rainProb, maxTemp) {
        let rainIcon = "ğŸ‘";
        let rainText = "ç©©å•¦ä¸ç”¨å¸¶å‚˜";
        if (parseInt(rainProb) > 60) {
          rainIcon = "â›ˆï¸";
          rainText = "æ€•ï¼è±ªé›¨è­¦å‘Šï¼";
        } else if (parseInt(rainProb) > 30) {
          rainIcon = "â˜”";
          rainText = "æ¬¸æ¬¸æœƒä¸‹é›¨è¨˜å¾—å¸¶å‚˜";
        }

        const temp = parseInt(maxTemp);
        let clothIcon = "ğŸ‘•";
        let clothText = "EasyçŸ­è¢–å°±è¡Œ";

        if (temp >= 30) {
          clothIcon = "ğŸ¥µ";
          clothText = "è¶…ç†±æ¬¸ï¼è¨˜å¾—é˜²æ›¬";
        } else if (temp >= 25) {
          clothIcon = "ğŸ½";
          clothText = "ä»Šä»”æ—¥ç©¿çŸ­è¢–å°±å¥½";
        } else if (temp >= 20) {
          clothIcon = "ğŸ‘š";
          clothText = "å¾®æ¶¼ é˜¿å¬¤è®“ä½ å¸¶è–„å¤–å¥—";
        } else if (temp >= 15) {
          clothIcon = "ğŸ§¥";
          clothText = "æœ‰å†·æ¬¸ é˜¿å¬¤è®“ä½ ç©¿åšä¸€é»";
        } else {
          clothIcon = "ğŸ§¤";
          clothText = "å¤ªå†·å•¦ é˜¿å¬¤è®“ä½ å…¨å‰¯æ­¦è£å•¦QAQ";
        }

        return { rainIcon, rainText, clothIcon, clothText };
      }

      function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
        document.getElementById(
          "clockTime"
        ).textContent = `${hours}:${minutes}`;
        document.getElementById("clockDate").textContent = `${
          now.getMonth() + 1
        }æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;
      }
      setInterval(updateClock, 1000);
      updateClock();

      function updateBackground(weather, startTime, rainProb) {
        const body = document.getElementById("mainBody");
        const hour = new Date(startTime).getHours();

        body.className = body.className
          .split(" ")
          .filter((c) => !c.startsWith("bg-"))
          .join(" ");

        if (parseInt(rainProb) > 60 || weather.includes("é›¨"))
          body.classList.add("bg-rainy");
        else if (hour >= 5 && hour < 7) body.classList.add("bg-dawn");
        else if (hour >= 7 && hour < 11) body.classList.add("bg-morning");
        else if (hour >= 11 && hour < 16) body.classList.add("bg-noon");
        else if (hour >= 16 && hour < 18) body.classList.add("bg-sunset");
        else if (hour >= 18 && hour < 20) body.classList.add("bg-evening");
        else body.classList.add("bg-night");

        const container = document.getElementById("decorations");
        container.innerHTML = "";
        const isNight = hour >= 18 || hour < 5;
        const isRaining = parseInt(rainProb) > 40 || weather.includes("é›¨");

        if (isRaining) {
          for (let i = 0; i < 30; i++) {
            const drop = document.createElement("div");
            drop.className = "rain-drop";
            drop.style.left = Math.random() * 100 + "%";
            drop.style.height = Math.random() * 20 + 10 + "px";
            drop.style.animationDuration = Math.random() * 0.5 + 0.5 + "s";
            drop.style.animationDelay = Math.random() * 2 + "s";
            container.appendChild(drop);
          }
        } else if (isNight) {
          for (let i = 0; i < 40; i++) {
            const star = document.createElement("div");
            star.className = "star";
            star.style.left = Math.random() * 100 + "%";
            star.style.top = Math.random() * 60 + "%";
            const size = Math.random() * 3 + 1 + "px";
            star.style.width = size;
            star.style.height = size;
            star.style.animationDuration = Math.random() * 2 + 1 + "s";
            star.style.animationDelay = Math.random() * 3 + "s";
            container.appendChild(star);
          }
        } else {
          for (let i = 0; i < 3; i++) {
            const cloud = document.createElement("div");
            cloud.className = "cloud-shape";
            cloud.style.width = Math.random() * 150 + 100 + "px";
            cloud.style.height = Math.random() * 150 + 100 + "px";
            cloud.style.top = Math.random() * 40 + "%";
            cloud.style.animationDuration = Math.random() * 20 + 20 + "s";
            cloud.style.animationDelay = i * 5 + "s";
            container.appendChild(cloud);
          }
        }
      }

      function renderWeather(data) {
        document.getElementById("selectedCity").textContent = data.city;
        const current = data.forecasts[0];
        const others = data.forecasts.slice(1);

        updateBackground(current.weather, current.startTime, current.rain);

        const assets = getWeatherAssets(current.weather, current.startTime);
        const avgTemp = Math.round(
          (parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2
        );

        // å–å¾—æœè£å»ºè­°
        const advice = getAdvice(current.rain, current.maxTemp);

        // 1. ä¸»å¡ç‰‡ HTML
        const heroHtml = `
          <div class="glass-card p-6 text-center relative overflow-hidden group">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-white opacity-20 blur-3xl rounded-full pointer-events-none"></div>
            
            <div class="flex flex-col items-center justify-center min-h-[160px]">
              <img 
                src="${assets.url}" 
                alt="${current.weather}" 
                class="w-40 h-40 object-contain drop-shadow-lg -my-4 transform transition-transform group-hover:scale-110 duration-500" 
                onerror="this.classList.add('error')"
              />
              <div class="fallback-emoji">${assets.emoji}</div>
              
              <div class="temp-display mt-2">${avgTemp}Â°</div>
              <div class="text-xl font-medium tracking-widest opacity-90 mb-2">${
                current.weather
              }</div>
              
              <div class="flex items-center justify-center gap-3 text-sm opacity-90 font-medium">
                <span>æœ€é«˜ ${parseInt(current.maxTemp)}Â°</span>
                <span class="opacity-50">|</span>
                <span>æœ€ä½ ${parseInt(current.minTemp)}Â°</span>
              </div>
            </div>
          </div>
        `;
        document.getElementById("heroCard").innerHTML = heroHtml;

        // 2. æœè£å»ºè­°å¡ç‰‡ HTML (ä½¿ç”¨ Tailwind å„ªåŒ–)
        const adviceHtml = `
            <div class="grid grid-cols-2 gap-3 text-center">
                <div class="p-3 rounded-xl flex flex-col items-center justify-center bg-white/10 dark:bg-black/20">
                    <span class="text-3xl advice-icon">${
                      advice.clothIcon
                    }</span>
                    <span class="text-xs opacity-70 mt-1">ç©¿æ­å»ºè­°</span>
                    <span class="text-sm font-bold mt-1">${
                      advice.clothText
                    }</span>
                </div>
                <div class="p-3 rounded-xl flex flex-col items-center justify-center bg-white/10 dark:bg-black/20">
                    <span class="text-3xl advice-icon">${advice.rainIcon}</span>
                    <span class="text-xs opacity-70 mt-1">å¸¶å‚˜æé†’</span>
                    <span class="text-sm font-bold mt-1">${
                      advice.rainText
                    }</span>
                </div>
            </div>
            <div class="text-xs opacity-50 mt-4 text-center">
                èˆ’é©åº¦: ${current.comfort || "ç„¡è³‡æ–™"} â€¢ é™é›¨æ©Ÿç‡: ${
          current.rain
        }
            </div>
        `;
        document.getElementById("adviceCard").innerHTML = adviceHtml;

        // 3. ç¨å¾Œé å ±
        const scrollContainer = document.getElementById("futureForecasts");
        scrollContainer.innerHTML = "";

        others.forEach((f) => {
          const fAssets = getWeatherAssets(f.weather, f.startTime);
          const timeLabel = getRelativeTimeLabel(f.startTime);

          scrollContainer.innerHTML += `
             <div class="glass-card p-4 rounded-2xl flex flex-col items-center justify-between text-center gap-2 hover:translate-y-[-2px] transition-transform">
               <span class="text-sm font-medium opacity-80">${timeLabel}</span>
               
               <div class="w-12 h-12 flex items-center justify-center my-1">
                 <img 
                    src="${fAssets.url}" 
                    class="w-full h-full object-contain drop-shadow-sm" 
                    onerror="this.classList.add('error')"
                 />
                 <div class="fallback-emoji text-2xl">${fAssets.emoji}</div>
               </div>

               <span class="font-bold text-lg">${parseInt(
                 f.minTemp
               )}Â° - ${parseInt(f.maxTemp)}Â°</span>
               <div class="text-xs opacity-60 flex items-center gap-1 bg-black/5 px-2 py-0.5 rounded-full dark:bg-white/10">
                  <span>â˜”</span> ${f.rain}
               </div>
             </div>
           `;
        });
      }

      // åŸå¸‚é¸å–®åŠŸèƒ½ (ä¸è®Š)
      const cities = [
        "è‡ºåŒ—å¸‚",
        "æ–°åŒ—å¸‚",
        "æ¡ƒåœ’å¸‚",
        "è‡ºä¸­å¸‚",
        "è‡ºå—å¸‚",
        "é«˜é›„å¸‚",
        "åŸºéš†å¸‚",
        "æ–°ç«¹å¸‚",
        "å˜‰ç¾©å¸‚",
        "æ–°ç«¹ç¸£",
        "è‹—æ —ç¸£",
        "å½°åŒ–ç¸£",
        "å—æŠ•ç¸£",
        "é›²æ—ç¸£",
        "å˜‰ç¾©ç¸£",
        "å±æ±ç¸£",
        "å®œè˜­ç¸£",
        "èŠ±è“®ç¸£",
        "è‡ºæ±ç¸£",
        "æ¾æ¹–ç¸£",
        "é‡‘é–€ç¸£",
        "é€£æ±Ÿç¸£",
      ];
      const dropdownContent = document.getElementById("dropdownContent");

      cities.forEach((city) => {
        const div = document.createElement("div");
        div.className = "dropdown-item";
        div.textContent = city;
        div.onclick = () => {
          fetchWeather(city);
          dropdownContent.classList.remove("show");
        };
        dropdownContent.appendChild(div);
      });

      document.getElementById("dropdownBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownContent.classList.toggle("show");
      });
      document.addEventListener("click", () =>
        dropdownContent.classList.remove("show")
      );

      // æ¨¡å¼åˆ‡æ›é‚è¼¯ (ä¸è®Š)
      const themeToggle = document.getElementById("themeToggle");
      const body = document.body;

      themeToggle.addEventListener("click", () => {
        if (body.classList.contains("dark-mode")) {
          body.classList.replace("dark-mode", "light-mode");
        } else {
          body.classList.replace("light-mode", "dark-mode");
        }
      });

      // --- IP å®šä½é‚è¼¯ (è§£æ±ºå•é¡Œ 1) ---
      async function detectCityByIP() {
        document.getElementById("loadingText").textContent =
          "æ­£åœ¨å˜—è©¦å®šä½æ‚¨çš„åŸå¸‚...";
        try {
          const res = await fetch(GEOIP_API_URL);
          const data = await res.json();

          if (data.status === "success" && data.city) {
            // ip-api.com å›å‚³çš„åŸå¸‚åç¨±
            let detectedCity = data.city;

            // ç°¡æ˜“è½‰æ›ï¼ˆå› ç‚º API å¯èƒ½å›å‚³ç°¡é«”æˆ–éæ¨™æº–åç¨±ï¼Œé€™è£¡ç›¡é‡è½‰ç‚ºå°ç£æ¨™æº–åŸå¸‚åï¼‰
            // é€™è£¡çš„é‚è¼¯éœ€è¦ä½ çš„å¾Œç«¯ API æ”¯æ´ï¼Œæˆ–è€…æˆ‘å€‘ç›´æ¥ç”¨å€åŸŸåç¨±å»æŸ¥ã€‚
            // ç”±æ–¼ CWA API åªæ”¯æ´ç›´è½„å¸‚/ç¸£å¸‚åç¨±ï¼Œæˆ‘å€‘ä½¿ç”¨å€åŸŸåç¨±ä¾†å°æ‡‰ã€‚
            const cityMap = {
              è‡ºåŒ—: "è‡ºåŒ—å¸‚",
              æ–°åŒ—: "æ–°åŒ—å¸‚",
              æ¡ƒåœ’: "æ¡ƒåœ’å¸‚",
              å°ä¸­: "è‡ºä¸­å¸‚",
              å°å—: "è‡ºå—å¸‚",
              é«˜é›„: "é«˜é›„å¸‚",
              åŸºéš†: "åŸºéš†å¸‚",
              æ–°ç«¹å¸‚: "æ–°ç«¹å¸‚",
              å˜‰ç¾©å¸‚: "å˜‰ç¾©å¸‚",
              æ–°ç«¹ç¸£: "æ–°ç«¹ç¸£",
              è‹—æ —: "è‹—æ —ç¸£",
              å½°åŒ–: "å½°åŒ–ç¸£",
              å—æŠ•: "å—æŠ•ç¸£",
              é›²æ—: "é›²æ—ç¸£",
              å˜‰ç¾©ç¸£: "å˜‰ç¾©ç¸£",
              å±æ±: "å±æ±ç¸£",
              å®œè˜­: "å®œè˜­ç¸£",
              èŠ±è“®: "èŠ±è“®ç¸£",
              å°æ±: "è‡ºæ±ç¸£",
              æ¾æ¹–: "æ¾æ¹–ç¸£",
              é‡‘é–€: "é‡‘é–€ç¸£",
              é€£æ±Ÿ: "é€£æ±Ÿç¸£",
            };

            let foundCity = Object.keys(cityMap).find((key) =>
              detectedCity.includes(key)
            );

            if (foundCity) {
              currentCity = cityMap[foundCity];
              document.getElementById(
                "loadingText"
              ).textContent = `åµæ¸¬åˆ°æ‚¨åœ¨ ${currentCity}ï¼`;
              return currentCity;
            }
          }
        } catch (e) {
          console.warn("IP å®šä½å¤±æ•—æˆ– IP æŸ¥è©¢ API è«‹æ±‚å—é™:", e);
        }

        document.getElementById("loadingText").textContent =
          "å®šä½å¤±æ•—ï¼Œé è¨­é¡¯ç¤ºè‡ºåŒ—å¸‚å¤©æ°£ã€‚";
        return "è‡ºåŒ—å¸‚";
      }

      // API æŠ“å–
      async function fetchWeather(city = null) {
        document.getElementById("loading").style.display = "flex";

        let finalCity = city;
        if (!finalCity) {
          finalCity = await detectCityByIP(); // å¦‚æœæ²’æœ‰æŒ‡å®šåŸå¸‚ï¼Œå°±åŸ·è¡Œå®šä½
        }

        const url = `${API_BASE_URL}/${encodeURIComponent(finalCity)}`;

        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.success) {
            renderWeather(json.data);
            currentCity = json.data.city;
            document.getElementById("loading").style.display = "none";
            document.getElementById("mainContent").style.display = "flex";
            document.getElementById("mainContent").classList.remove("hidden");
          } else {
            // è™•ç† API é›–ç„¶æˆåŠŸä½†æ²’æœ‰å¤©æ°£è³‡æ–™ (ä¾‹å¦‚åŸå¸‚åç¨±ä¸ç¬¦)
            console.error("API æŸ¥ç„¡è³‡æ–™:", json.message);
            alert(`æŸ¥ç„¡ ${finalCity} çš„å¤©æ°£è³‡æ–™ï¼Œè«‹æ‰‹å‹•é¸æ“‡å…¶ä»–åŸå¸‚ã€‚`);
            fetchWeather("è‡ºåŒ—å¸‚"); // å›åˆ°é è¨­åŸå¸‚
          }
        } catch (e) {
          console.error("è®€å–å¤©æ°£å¤±æ•—:", e);
          alert("è®€å–å¤©æ°£å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
          document.getElementById("loading").style.display = "none";
        }
      }

      document.addEventListener("DOMContentLoaded", () => fetchWeather());
    </script>
  </body>
</html>
